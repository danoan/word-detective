<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Hints — #languageName# - Word Detective Admin</title>
    <link rel="stylesheet" href="/admin/css/admin.css">
</head>
<body>
    <div class="admin-container words-container">
        <a href="/admin" class="back-link">&larr; Back to Dashboard</a>

        <header class="admin-header">
            <h1>Password Hints &mdash; #languageName#</h1>
            <p class="subtitle">Manage word hints for the Password game</p>
        </header>

        <nav class="language-tabs">
            <a href="/admin/password-hints/en" class="language-tab" data-lang="en">English</a>
            <a href="/admin/password-hints/it" class="language-tab" data-lang="it">Italian</a>
            <a href="/admin/password-hints/fr" class="language-tab" data-lang="fr">French</a>
            <a href="/admin/password-hints/pt" class="language-tab" data-lang="pt">Portuguese</a>
        </nav>

        <section class="hints-section">
            <h2>Existing Hints <span id="hints-count"></span></h2>
            <div class="hints-list" id="hints-list">
                <!-- Hint chips populated by JS -->
            </div>
        </section>

        <section class="missing-section">
            <h2>Missing Words <span id="missing-count"></span></h2>

            <div class="filters-section">
                <div class="filter-group">
                    <label for="search-input">Search</label>
                    <input type="text" id="search-input" placeholder="Filter words...">
                </div>
                <div class="filter-group">
                    <label for="min-length">Min Length</label>
                    <input type="number" id="min-length" min="1" placeholder="Min">
                </div>
                <div class="filter-group">
                    <label for="max-length">Max Length</label>
                    <input type="number" id="max-length" min="1" placeholder="Max">
                </div>
                <div class="selection-controls">
                    <button class="btn btn-small btn-secondary" onclick="selectAll()">Select All</button>
                    <button class="btn btn-small btn-secondary" onclick="selectNone()">Select None</button>
                    <button class="btn btn-small btn-secondary" onclick="invertSelection()">Invert</button>
                    <button class="btn btn-small btn-secondary" onclick="clearFilters()">Clear Filters</button>
                </div>
            </div>

            <div class="selection-info">
                <span class="selected-count"><span id="selected-count">0</span> words selected</span>
                <span class="visible-count"><span id="visible-count">0</span> words visible</span>
            </div>

            <div class="words-grid" id="words-grid">
                <!-- Missing words populated by JS -->
            </div>
        </section>

        <section class="generate-section">
            <h2>Generate Hints</h2>
            <button class="btn btn-primary" id="btn-generate">Generate Hints</button>
            <span id="generate-status" class="status-text"></span>

            <div class="progress-section" id="progress-section">
                <div class="progress-counter" id="progress-counter">0 / 0</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="progress-log" id="progress-log">
                    <!-- Log entries appear here -->
                </div>
            </div>
        </section>
    </div>

    <script>
        const languageCode = '#languageCode#';
        const hintsData = #hintsData#;
        const missingWords = #missingWords#;
        const selectedWords = new Set();

        // Highlight active language tab
        document.querySelectorAll('.language-tab').forEach(tab => {
            if (tab.dataset.lang === languageCode) {
                tab.classList.add('active');
            }
        });

        function renderHints() {
            const list = document.getElementById('hints-list');
            const countEl = document.getElementById('hints-count');
            const words = Object.keys(hintsData).sort();

            countEl.textContent = `(${words.length})`;

            if (words.length === 0) {
                list.innerHTML = '<p style="color:#7f8c8d;font-style:italic;">No hints generated yet.</p>';
                return;
            }

            list.innerHTML = '';
            for (const word of words) {
                const chip = document.createElement('span');
                chip.className = 'hint-chip';

                const wordText = document.createElement('span');
                wordText.textContent = word;

                const cluesEl = document.createElement('span');
                cluesEl.className = 'hint-chip-clues';
                cluesEl.textContent = hintsData[word].join(', ');

                chip.appendChild(wordText);
                chip.appendChild(cluesEl);

                chip.addEventListener('click', () => {
                    chip.classList.toggle('expanded');
                });

                list.appendChild(chip);
            }
        }

        function getCheckboxForWord(word) {
            const item = document.querySelector(`.word-item[data-word="${CSS.escape(word)}"]`);
            return item ? item.querySelector('input[type="checkbox"]') : null;
        }

        function renderMissingWords() {
            const grid = document.getElementById('words-grid');
            const countEl = document.getElementById('missing-count');

            countEl.textContent = `(${missingWords.length})`;
            grid.innerHTML = '';

            for (const word of missingWords) {
                const item = document.createElement('div');
                item.className = 'word-item';
                item.dataset.word = word;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = selectedWords.has(word);
                checkbox.addEventListener('change', function() {
                    toggleWord(word, this.checked);
                });

                const label = document.createElement('label');
                label.textContent = word;
                label.addEventListener('click', function() {
                    checkbox.checked = !checkbox.checked;
                    toggleWord(word, checkbox.checked);
                });

                item.appendChild(checkbox);
                item.appendChild(label);
                grid.appendChild(item);
            }

            updateCounts();
        }

        function toggleWord(word, checked) {
            if (checked) {
                selectedWords.add(word);
            } else {
                selectedWords.delete(word);
            }
            updateCounts();
        }

        function applyFilters() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const minLength = parseInt(document.getElementById('min-length').value) || 0;
            const maxLength = parseInt(document.getElementById('max-length').value) || Infinity;

            const items = document.querySelectorAll('.word-item');
            for (const item of items) {
                const word = item.dataset.word;
                const matchesSearch = word.toLowerCase().includes(search);
                const matchesLength = word.length >= minLength && word.length <= maxLength;

                if (matchesSearch && matchesLength) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            }

            updateCounts();
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('min-length').value = '';
            document.getElementById('max-length').value = '';
            applyFilters();
        }

        function getVisibleWords() {
            const visible = [];
            const items = document.querySelectorAll('.word-item:not(.hidden)');
            for (const item of items) {
                visible.push(item.dataset.word);
            }
            return visible;
        }

        function selectAll() {
            const visibleWords = getVisibleWords();
            for (const word of visibleWords) {
                selectedWords.add(word);
                const checkbox = getCheckboxForWord(word);
                if (checkbox) checkbox.checked = true;
            }
            updateCounts();
        }

        function selectNone() {
            const visibleWords = getVisibleWords();
            for (const word of visibleWords) {
                selectedWords.delete(word);
                const checkbox = getCheckboxForWord(word);
                if (checkbox) checkbox.checked = false;
            }
            updateCounts();
        }

        function invertSelection() {
            const visibleWords = getVisibleWords();
            for (const word of visibleWords) {
                const checkbox = getCheckboxForWord(word);
                if (selectedWords.has(word)) {
                    selectedWords.delete(word);
                    if (checkbox) checkbox.checked = false;
                } else {
                    selectedWords.add(word);
                    if (checkbox) checkbox.checked = true;
                }
            }
            updateCounts();
        }

        function updateCounts() {
            const visibleWords = getVisibleWords();
            document.getElementById('selected-count').textContent = selectedWords.size;
            document.getElementById('visible-count').textContent = visibleWords.length;
        }

        document.getElementById('btn-generate').addEventListener('click', async function() {
            if (selectedWords.size === 0) {
                alert('Please select at least one word');
                return;
            }

            const btn = this;
            const statusEl = document.getElementById('generate-status');
            const progressSection = document.getElementById('progress-section');
            const progressBar = document.getElementById('progress-bar');
            const progressCounter = document.getElementById('progress-counter');
            const progressLog = document.getElementById('progress-log');

            btn.disabled = true;
            statusEl.textContent = 'Generating...';
            statusEl.className = 'status-text';
            progressSection.classList.add('visible');
            progressBar.style.width = '0%';
            progressCounter.textContent = `0 / ${selectedWords.size}`;
            progressLog.innerHTML = '';

            try {
                const response = await fetch(`/admin/password-hints/${languageCode}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ words: Array.from(selectedWords) })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.trim()) continue;

                        try {
                            const msg = JSON.parse(line);

                            if (msg.type === 'progress') {
                                const pct = Math.round((msg.current / msg.total) * 100);
                                progressBar.style.width = pct + '%';
                                progressCounter.textContent = `${msg.current} / ${msg.total}`;

                                const entry = document.createElement('div');
                                if (msg.error) {
                                    entry.className = 'log-entry log-invalid';
                                    entry.textContent = `${msg.word} — error: ${msg.error}`;
                                } else {
                                    entry.className = 'log-entry log-valid';
                                    entry.textContent = `${msg.word} — ${msg.hints.join(', ')}`;
                                }
                                progressLog.appendChild(entry);
                                progressLog.scrollTop = progressLog.scrollHeight;
                            } else if (msg.type === 'complete') {
                                if (msg.success) {
                                    statusEl.textContent = `Done. Generated hints for ${msg.generated}/${msg.total} words.`;
                                    statusEl.className = 'status-text success';
                                } else {
                                    statusEl.textContent = 'Generation failed: ' + (msg.message || 'Unknown error');
                                    statusEl.className = 'status-text error';
                                }
                            }
                        } catch (e) {
                            // skip non-JSON lines
                        }
                    }
                }
            } catch (error) {
                statusEl.textContent = 'Error: ' + error.message;
                statusEl.className = 'status-text error';
            } finally {
                btn.disabled = false;
            }
        });

        // Event listeners for filters
        document.getElementById('search-input').addEventListener('input', applyFilters);
        document.getElementById('min-length').addEventListener('input', applyFilters);
        document.getElementById('max-length').addEventListener('input', applyFilters);

        // Initial render
        renderHints();
        renderMissingWords();
    </script>
</body>
</html>
