<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel='stylesheet' type='text/css' media='screen' href='/assets/css/master.css'>
    <link rel='stylesheet' type='text/css' media='screen' href='/admin/css/admin.css'>
    <title>Word Detective - Admin</title>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>Word Detective Admin</h1>
            <p>Manage corpora and language bricks</p>
        </header>

        <div class="actions-section">
            <button class="btn btn-primary" onclick="regenerateWeekPuzzles()" id="regen-btn">
                Regenerate Week Puzzles
            </button>
            <span id="regen-status"></span>
        </div>

        <div id="corpora-container"></div>

        <div class="upload-section">
            <h2>Upload New Corpus</h2>
            <form action="/admin/upload" method="POST" enctype="multipart/form-data" class="upload-form">
                <div class="form-group">
                    <label for="name">Corpus Name:</label>
                    <input type="text" id="name" name="name" placeholder="e.g., en-10K" required>
                </div>
                <div class="form-group">
                    <label for="language">Language:</label>
                    <select id="language" name="language" required>
                        <option value="en">English</option>
                        <option value="it">Italian</option>
                        <option value="fr">French</option>
                        <option value="pt">Portuguese</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="corpus">Corpus File (.txt):</label>
                    <input type="file" id="corpus" name="corpus" accept=".txt" required>
                </div>
                <button type="submit" class="btn btn-primary">Upload Corpus</button>
            </form>
        </div>

        <div class="upload-section text-section">
            <h2>Create Corpus from Text</h2>
            <form action="/admin/create-from-text" method="POST" class="upload-form">
                <div class="form-group">
                    <label for="text-name">Corpus Name:</label>
                    <input type="text" id="text-name" name="name" placeholder="e.g., en-custom" required>
                </div>
                <div class="form-group">
                    <label for="text-language">Language:</label>
                    <select id="text-language" name="language" required>
                        <option value="en">English</option>
                        <option value="it">Italian</option>
                        <option value="fr">French</option>
                        <option value="pt">Portuguese</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="text-content">Text (words will be extracted, deduplicated, and sorted):</label>
                    <textarea id="text-content" name="text" rows="8" placeholder="Paste your text here. All unique words will be extracted..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Create Corpus</button>
            </form>
        </div>
    </div>

    <script>
        const corporaData = #corporaData#;

        function renderCorpora() {
            const container = document.getElementById('corpora-container');
            container.innerHTML = '';

            for (const [langCode, langData] of Object.entries(corporaData)) {
                const section = document.createElement('section');
                section.className = 'language-section';
                section.innerHTML = `
                    <h2>${langData.name}</h2>
                    <div class="corpora-list">
                        ${langData.sources.length === 0 ? '<p class="no-corpora">No corpora available</p>' :
                        langData.sources.map(source => `
                            <div class="corpus-item ${source.name === langData.active ? 'active' : ''}">
                                <div class="corpus-info">
                                    <span class="corpus-name">${source.name}</span>
                                    ${source.name === langData.active ? '<span class="active-badge">Active</span>' : ''}
                                </div>
                                <div class="corpus-actions">
                                    ${source.name !== langData.active ? `
                                        <form action="/admin/activate/${langCode}/${source.name}" method="POST" class="inline-form">
                                            <button type="submit" class="btn btn-small btn-activate">Activate</button>
                                        </form>
                                    ` : ''}
                                    <a href="/admin/corpus/${source.name}/words" class="btn btn-small btn-words">Words</a>
                                    <a href="/admin/download/${source.name}" class="btn btn-small btn-download">Download</a>
                                    <form action="/admin/remove/${source.name}" method="POST" class="inline-form" onsubmit="return confirm('Are you sure you want to remove ${source.name}?');">
                                        <button type="submit" class="btn btn-small btn-remove">Remove</button>
                                    </form>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(section);
            }
        }

        async function regenerateWeekPuzzles() {
            const btn = document.getElementById('regen-btn');
            const status = document.getElementById('regen-status');

            btn.disabled = true;
            btn.textContent = 'Generating...';
            status.textContent = '';

            try {
                const response = await fetch('/admin/regenerate-week-puzzles', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    const summary = result.results.map(r =>
                        `${r.language}: ${r.status}${r.days ? ` (${r.days} days)` : ''}${r.reason ? ` - ${r.reason}` : ''}`
                    ).join(', ');
                    status.textContent = summary;
                    status.style.color = 'green';
                } else {
                    status.textContent = 'Error: ' + result.error;
                    status.style.color = 'red';
                }
            } catch (error) {
                status.textContent = 'Error: ' + error.message;
                status.style.color = 'red';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Regenerate Week Puzzles';
            }
        }

        renderCorpora();
    </script>
</body>
</html>
